var ArrayRule = Class.bind(null, 'ArrayRule', ValidationRule);

ArrayRule({
    constructor: function (fieldRules) {
        this.fieldRules = fieldRules;
    },
    validate: function (context, fullData, currentValue, callback) {
        var failed = false;

        if (!currentValue) {
            return callback(true);
        }

        if (!(currentValue instanceof Array)) {
            context.errors.push('Field must be an array.');
            return callback(false);
        }

        var ch = new CompletionHandler();
        var preWait = ch.wait('D');

        var doneCheck = function (done, result) {
            if (!result) {
                failed = true;
            }

            done();
        };

        for (var i = 0; i < currentValue.length; i++) {
            // create a new context for this field
            context.fields[i] = { errors: [], success: true, fields: {} };

            var target = currentValue[i];

            // validate each of the rules for the current field
            for (var x = 0; x < this.fieldRules.length; x++) {
                this.fieldRules[x].validate(
                    context.fields[i],
                    fullData,
                    target,
                    doneCheck.bind(this, ch.wait('D'))
                );
            }
        }

        ch.handle('D', function () {
            callback(!failed);
        });
        preWait();
    }
});